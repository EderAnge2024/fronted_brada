import{p as B,r as c,k as q,n as O,b as W,j as t}from"./index-DM_27y1d.js";const z="_container_1rgk3_1",G="_formContainer_1rgk3_25",L="_formTitle_1rgk3_41",M="_form_1rgk3_25",U="_input_1rgk3_63",R="_selecthistorial_1rgk3_75",J="_button_1rgk3_97",K="_listContainer_1rgk3_133",Q="_listTitle_1rgk3_141",V="_historialCard_1rgk3_151",X="_historialInfo_1rgk3_175",Y="_actions_1rgk3_183",Z="_deleteButton_1rgk3_197",ee="_editButton_1rgk3_213",te="_modalOverlay_1rgk3_229",oe="_modalWindow_1rgk3_255",ae="_modalClose_1rgk3_273",se="_modalTitle_1rgk3_299",ie="_modalForm_1rgk3_309",ne="_botones_1rgk3_319",re="_statusIndicator_1rgk3_333",o={container:z,formContainer:G,formTitle:L,form:M,input:U,selecthistorial:R,button:J,listContainer:K,listTitle:Q,historialCard:V,historialInfo:X,actions:Y,deleteButton:Z,editButton:ee,modalOverlay:te,modalWindow:oe,modalClose:ae,modalTitle:se,modalForm:ie,botones:ne,statusIndicator:re,"status-active":"_status-active_1rgk3_349"},le=()=>{const{addHistorialEstado:N,fetchHistorialEstado:_,historialEstados:u,deleteHistorialEstado:v,updateHistorialEstado:b}=B(),[C,m]=c.useState(null),{estadoPedidos:h,fetchEstadoPedido:k}=q(),{pedidos:r,fetchPedido:y}=O(),{clientes:I,clienteActual:s,isAuthenticated:n,initializeFromStorage:F}=W(),[d,E]=c.useState({ID_EstadoPedido:"",ID_Pedido:"",Fecha:""}),[l,P]=c.useState({ID_EstadoPedido:"",ID_Pedido:"",Fecha:""});c.useEffect(()=>{(async()=>{F(),_(),k(),y()})()},[]);const p=e=>{if(!e)return"No asignado";const a=r.find(i=>i.ID_Pedido===e);if(!a)return"Pedido no encontrado";if(s&&s.ID_Cliente===a.ID_Cliente)return`${s.Nombre} ${s.Apellido}`;if(I&&I.length>0){const i=I.find(g=>g.ID_Cliente===a.ID_Cliente);return i?`${i.Nombre} ${i.Apellido}`:"Cliente desconocido"}return"Cliente no disponible"},D=e=>{if(!n||!s)return!1;const a=r.find(i=>i.ID_Pedido===e.ID_Pedido);return a&&a.ID_Cliente===s.ID_Cliente},H=c.useMemo(()=>!n||!s?u:u.filter(e=>{const a=r.find(i=>i.ID_Pedido===e.ID_Pedido);return a&&a.ID_Cliente===s.ID_Cliente}),[u,r,s,n]),f=e=>{const{name:a,value:i}=e.target;E({...d,[a]:i})},S=async e=>{if(e.preventDefault(),n&&s){const a=r.find(i=>i.ID_Pedido===d.ID_Pedido);if(a&&a.ID_Cliente!==s.ID_Cliente){alert("No tienes permisos para agregar historial a este pedido");return}}try{await N(d),E({ID_EstadoPedido:"",ID_Pedido:"",Fecha:""}),alert("Se agregó un nuevo historial de pedidos"),_()}catch(a){console.error("Error al agregar historial:",a),alert("Error al agregar el historial")}},T=async e=>{const a=u.find(i=>i.ID_Historial===e);if(n&&s&&!D(a)){alert("No tienes permisos para eliminar este historial");return}if(window.confirm("¿Estás seguro de eliminar este historial?"))try{await v(e),_()}catch(i){console.error("Error al eliminar historial:",i),alert("Error al eliminar el historial")}},$=e=>{if(n&&s&&!D(e)){alert("No tienes permisos para editar este historial");return}m(e),P({ID_EstadoPedido:e.ID_EstadoPedido,ID_Pedido:e.ID_Pedido,Fecha:e.Fecha})},x=e=>{P({...l,[e.target.name]:e.target.value})},w=async()=>{try{await b(C.ID_Historial,l),_(),m(null)}catch(e){console.error("Error al actualizar historial:",e),alert("Error al actualizar el historial")}},j=()=>{m(null)},A=c.useMemo(()=>!n||!s?r:r.filter(e=>e.ID_Cliente===s.ID_Cliente),[r,s,n]);return t.jsxs("div",{className:o.container,children:[t.jsxs("div",{className:o.formContainer,children:[t.jsx("h1",{className:o.formTitle,children:"Agregar Historial de Estados"}),n&&s&&t.jsxs("p",{className:o.userInfo,children:["Conectado como: ",s.Nombre," ",s.Apellido]}),t.jsxs("form",{onSubmit:S,className:o.form,children:[t.jsxs("select",{name:"ID_EstadoPedido",value:d.ID_EstadoPedido,onChange:f,required:!0,className:o.selecthistorial,children:[t.jsx("option",{value:"",children:"-- Seleccionar estado --"}),h.map(e=>t.jsx("option",{value:e.ID_EstadoPedido,children:e.Estado},e.ID_EstadoPedido))]}),t.jsxs("select",{name:"ID_Pedido",value:d.ID_Pedido,onChange:f,required:!0,className:o.selecthistorial,children:[t.jsx("option",{value:"",children:"-- Seleccionar pedido --"}),A.map(e=>t.jsxs("option",{value:e.ID_Pedido,children:["Pedido #",e.ID_Pedido," - ",p(e.ID_Pedido)]},e.ID_Pedido))]}),t.jsx("input",{className:o.input,type:"date",placeholder:"Fecha",required:!0,name:"Fecha",value:d.Fecha,onChange:f}),t.jsx("button",{type:"submit",className:o.button,children:"Guardar Datos"})]})]}),t.jsxs("div",{className:o.listContainer,children:[t.jsx("h1",{className:o.listTitle,children:"Lista de Historiales"}),t.jsx("div",{children:H.map(e=>{const a=h.find(g=>g.ID_EstadoPedido===e.ID_EstadoPedido),i=D(e);return t.jsxs("div",{className:o.historialCard,children:[t.jsxs("p",{className:o.historialInfo,children:[t.jsx("span",{className:`${o.statusIndicator} ${o["status-active"]}`}),"Estado: ",(a==null?void 0:a.Estado)||"Desconocido"]}),t.jsxs("p",{className:o.historialInfo,children:["Pedido: #",e.ID_Pedido]}),t.jsxs("p",{className:o.historialInfo,children:["Cliente: ",p(e.ID_Pedido)]}),t.jsxs("p",{className:o.historialInfo,children:["Fecha: ",new Date(e.Fecha).toLocaleDateString()]}),(!n||!s||i)&&t.jsxs("div",{className:o.actions,children:[t.jsx("button",{onClick:()=>T(e.ID_Historial),className:`${o.button} ${o.deleteButton}`,children:"Eliminar"}),t.jsx("button",{onClick:()=>$(e),className:`${o.button} ${o.editButton}`,children:"Editar"})]})]},e.ID_Historial)})}),C&&t.jsx("div",{className:o.modalOverlay,children:t.jsxs("div",{className:o.modalWindow,children:[t.jsx("span",{className:o.modalClose,onClick:j,children:"×"}),t.jsx("h3",{className:o.modalTitle,children:"Editar Historial"}),t.jsxs("div",{className:o.modalForm,children:[t.jsxs("select",{name:"ID_EstadoPedido",value:l.ID_EstadoPedido,onChange:x,required:!0,className:o.selecthistorial,children:[t.jsx("option",{value:"",children:"-- Seleccionar estado --"}),h.map(e=>t.jsx("option",{value:e.ID_EstadoPedido,children:e.Estado},e.ID_EstadoPedido))]}),t.jsx("input",{className:o.input,type:"text",name:"cliente_readonly",value:`Pedido #${l.ID_Pedido} - ${p(l.ID_Pedido)}`,readOnly:!0,placeholder:"Información del pedido"}),t.jsx("input",{className:o.input,type:"date",name:"Fecha",value:l.Fecha,onChange:x,required:!0}),t.jsxs("div",{className:o.botones,children:[t.jsx("button",{type:"button",onClick:w,className:o.button,children:"Guardar"}),t.jsx("button",{type:"button",onClick:j,className:o.button,children:"Cancelar"})]})]})]})})]})]})};export{le as default};
