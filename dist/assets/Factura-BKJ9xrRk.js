import{l as D,m as ue,b as me,n as he,h as _e,e as pe,r as h,j as t,F as xe,o as je}from"./index-DM_27y1d.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],be=D("download",Ce);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],Fe=D("eye",De);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],B=D("phone",Ne);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],W=D("send",ge);/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],U=D("x",fe),ve="_container_1q926_1",Ie="_header_1q926_13",Pe="_formContainer_1q926_25",ye="_formTitle_1q926_41",$e="_form_1q926_25",Se="_input_1q926_63",Ee="_button_1q926_77",Te="_listContainer_1q926_113",we="_listTitle_1q926_121",ke="_facturaCard_1q926_131",Me="_facturaInfo_1q926_155",qe="_actions_1q926_163",Ae="_deleteButton_1q926_175",Oe="_editButton_1q926_191",ze="_modalOverlay_1q926_207",Le="_modalWindow_1q926_233",Be="_modalClose_1q926_251",We="_modalTitle_1q926_277",Ue="_modalForm_1q926_287",Ve="_botones_1q926_297",a={container:ve,header:Ie,formContainer:Pe,formTitle:ye,form:$e,input:Se,button:Ee,listContainer:Te,listTitle:we,facturaCard:ke,facturaInfo:Me,actions:qe,deleteButton:Ae,editButton:Oe,modalOverlay:ze,modalWindow:Le,modalClose:Be,modalTitle:We,modalForm:Ue,botones:Ve},q={ID_Pedido:"",ID_Cliente:"",Fecha:"",Monto_Total:""},Ge=()=>{const{addFactura:V,fetchFactura:u,facturas:F,deleteFactura:R,updateFactura:G}=ue(),{clientes:_,fetchCliente:I,isAuthenticated:m,clienteActual:i,loading:N}=me(),{pedidos:p,fetchPedido:P}=he(),{detallePedidos:y,fetchDetallePedido:$}=_e(),{productos:x,fetchProducto:S}=pe(),[c,E]=h.useState(q),[g,C]=h.useState(null),[s,A]=h.useState(null),[j,d]=h.useState(!1),[b,H]=h.useState(!1),[T,O]=h.useState({texto:"",tipo:""});h.useEffect(()=>{N||(async()=>{try{d(!0);const o=[];u&&o.push(u()),I&&o.push(I()),P&&o.push(P()),$&&o.push($()),S&&o.push(S()),await Promise.all(o),H(!0)}catch(o){console.error("Error al cargar datos:",o),r("Error al cargar datos","error")}finally{d(!1)}})()},[N,u,I,P,$,S]),h.useEffect(()=>{m&&(i!=null&&i.ID_Cliente)&&E(e=>({...e,ID_Cliente:i.ID_Cliente.toString()}))},[m,i]);const r=h.useCallback((e,o="success")=>{O({texto:e,tipo:o}),setTimeout(()=>O({texto:"",tipo:""}),5e3)},[]),f=()=>b&&(_==null?void 0:_.length)>0&&(p==null?void 0:p.length)>0&&(x==null?void 0:x.length)>0,X=e=>{const{name:o,value:n}=e.target;E(l=>({...l,[o]:n}))},Y=async e=>{var o;if(e.preventDefault(),!m&&!c.ID_Cliente){r("Debe especificar un ID de cliente o iniciar sesión","error");return}try{d(!0);const n={...c,ID_Cliente:c.ID_Cliente||((o=i==null?void 0:i.ID_Cliente)==null?void 0:o.toString())};await V(n),E({...q,ID_Cliente:m?i.ID_Cliente.toString():""}),r("Factura agregada exitosamente"),u&&await u()}catch(n){console.error("Error al agregar factura:",n),r("Error al agregar factura","error")}finally{d(!1)}},J=async e=>{if(window.confirm("¿Estás seguro de eliminar esta factura?"))try{d(!0),await R(e),u&&await u(),r("Factura eliminada correctamente")}catch(o){console.error("Error al eliminar factura:",o),r("Error al eliminar factura","error")}finally{d(!1)}},K=e=>{C({...e,formData:{...e}})},Q=e=>{const{name:o,value:n}=e.target;C(l=>({...l,formData:{...l.formData,[o]:n}}))},Z=async()=>{try{d(!0),await G(g.ID_Factura,g.formData),u&&await u(),C(null),r("Factura actualizada correctamente")}catch(e){console.error("Error al actualizar factura:",e),r("Error al actualizar factura","error")}finally{d(!1)}},z=e=>m&&i&&String(i.ID_Cliente).trim()===String(e).trim()?i:(_==null?void 0:_.find(n=>String(n.ID_Cliente).trim()===String(e).trim()))||{ID_Cliente:e,Nombre:"Cliente no encontrado",Apellido:`(ID: ${e})`,NumCelular:""},ee=e=>(p==null?void 0:p.find(n=>String(n.ID_Pedido).trim()===String(e).trim()))||{ID_Pedido:e,Fecha_Pedido:new Date().toISOString(),Fecha_Entrega:"",Observaciones:"Pedido no encontrado"},te=e=>{const o=y==null?void 0:y.filter(n=>String(n.ID_Pedido).trim()===String(e).trim());return!o||o.length===0?[{ID_Detalle:"GENERICO",ID_Pedido:e,ID_Producto:"SERVICIO",Nombre_Producto:"Producto/Servicio",Cantidad:1,Precio_Unitario:parseFloat(c==null?void 0:c.Monto_Total)||0,Subtotal:parseFloat(c==null?void 0:c.Monto_Total)||0}]:o.map(n=>{const l=x==null?void 0:x.find(k=>String(k.ID_Producto).trim()===String(n.ID_Producto).trim());return{...n,Nombre_Producto:(l==null?void 0:l.Nombre_Producto)||`Producto ${n.ID_Producto}`,Precio_Unitario:parseFloat(n.Precio_Unitario)||0,Cantidad:parseInt(n.Cantidad)||0,Subtotal:parseFloat(n.Subtotal)||0}})},v=e=>{if(!e)return"";try{return new Date(e).toLocaleDateString("es-ES")}catch{return""}},w=e=>{if(!(e!=null&&e.ID_Cliente)||!(e!=null&&e.ID_Pedido)||!f())return null;const o=z(e.ID_Cliente),n=ee(e.ID_Pedido),l=te(e.ID_Pedido);return{factura:{ID_Factura:e.ID_Factura||"N/A",Fecha:v(e.Fecha),Monto_Total:parseFloat(e.Monto_Total)||0},cliente:o,pedido:{...n,Fecha_Pedido:v(n.Fecha_Pedido),Fecha_Entrega:v(n.Fecha_Entrega)},detalles:l,total:parseFloat(e.Monto_Total)||0}},ae=async e=>{if(!f()){r("Los datos aún se están cargando","error");return}try{d(!0);const o=w(e);if(!o)throw new Error("No se pudieron obtener los datos completos de la factura");const n=je(o);n!=null&&n.success&&r("PDF generado y descargado exitosamente")}catch(o){console.error("Error al generar PDF:",o),r(`Error al generar PDF: ${o.message}`,"error")}finally{d(!1)}},L=e=>{if(!f()){r("Los datos aún se están cargando","error");return}const o=w(e);if(!o){r("No se pudieron obtener los datos completos","error");return}const{cliente:n,pedido:l,detalles:k,total:ie}=o;if(!n.NumCelular){r("Cliente no tiene número de teléfono registrado","error");return}const le=k.map(M=>`• ${M.Nombre_Producto} x${M.Cantidad} - $${M.Subtotal.toFixed(2)}`).join(`
`),ce=`🎉 ¡Hola ${n.Nombre}!

✅ Tu factura #${e.ID_Factura} del pedido #${e.ID_Pedido} está lista.

📋 DETALLES:
${le}

💰 Total: $${ie.toFixed(2)}
📅 Fecha de entrega: ${l.Fecha_Entrega||"Por definir"}
${l.Observaciones?`📝 Observaciones: ${l.Observaciones}`:""}

¡Gracias por tu preferencia! 😊`,de=`https://wa.me/51${n.NumCelular}?text=${encodeURIComponent(ce)}`;window.open(de,"_blank"),r(`Mensaje enviado al cliente: ${n.Nombre} ${n.Apellido}`)},oe=e=>{if(!f()){r("Los datos aún se están cargando","error");return}const o=w(e);o&&A(o)},ne=({factura:e})=>{const o=z(e.ID_Cliente);return t.jsxs("div",{className:a.facturaCard,children:[t.jsxs("div",{className:a.facturaInfo,children:[t.jsxs("div",{className:a.facturaHeader,children:[t.jsxs("h3",{children:["Factura #",e.ID_Factura]}),t.jsxs("span",{className:a.monto,children:["$",e.Monto_Total]})]}),t.jsxs("p",{children:["ID Pedido: ",e.ID_Pedido]}),t.jsxs("p",{children:["Cliente: ",o.Nombre," ",o.Apellido]}),t.jsxs("p",{children:["Fecha: ",v(e.Fecha)]}),o.NumCelular&&t.jsxs("p",{className:a.telefono,children:[t.jsx(B,{size:16}),o.NumCelular]})]}),t.jsxs("div",{className:a.actions,children:[t.jsxs("button",{onClick:()=>oe(e),className:`${a.button} ${a.viewButton}`,title:"Ver detalles",disabled:!b,children:[t.jsx(Fe,{size:16})," Ver"]}),t.jsxs("button",{onClick:()=>ae(e),className:`${a.button} ${a.pdfButton}`,disabled:j||!b,title:"Descargar PDF",children:[t.jsx(be,{size:16})," PDF"]}),t.jsxs("button",{onClick:()=>L(e),className:`${a.button} ${a.whatsappButton}`,disabled:j||!b,title:"Enviar por WhatsApp",children:[t.jsx(W,{size:16})," WhatsApp"]}),t.jsx("button",{onClick:()=>K(e),className:`${a.button} ${a.editButton}`,children:"Editar"}),t.jsx("button",{onClick:()=>J(e.ID_Factura),className:`${a.button} ${a.deleteButton}`,children:"Eliminar"})]})]},e.ID_Factura)},se=()=>s?t.jsx("div",{className:a.modalOverlay,children:t.jsxs("div",{className:a.modalWindow,children:[t.jsx("button",{className:a.modalClose,onClick:()=>A(null),children:t.jsx(U,{size:20})}),t.jsxs("h3",{className:a.modalTitle,children:[t.jsx(xe,{size:20}),"Detalles de Factura #",s.factura.ID_Factura]}),t.jsxs("div",{className:a.facturaDetalles,children:[t.jsxs("div",{className:a.seccion,children:[t.jsx("h4",{children:"Cliente"}),t.jsx("p",{children:t.jsxs("strong",{children:[s.cliente.Nombre," ",s.cliente.Apellido]})}),s.cliente.NumCelular&&t.jsxs("p",{children:[t.jsx(B,{size:14})," ",s.cliente.NumCelular]})]}),t.jsxs("div",{className:a.seccion,children:[t.jsxs("h4",{children:["Pedido #",s.pedido.ID_Pedido]}),t.jsxs("p",{children:["Fecha del pedido: ",s.pedido.Fecha_Pedido]}),s.pedido.Fecha_Entrega&&t.jsxs("p",{children:["Fecha de entrega: ",s.pedido.Fecha_Entrega]}),s.pedido.Observaciones&&t.jsxs("p",{children:["Observaciones: ",s.pedido.Observaciones]})]}),t.jsxs("div",{className:a.seccion,children:[t.jsx("h4",{children:"Productos"}),t.jsx("div",{className:a.productosLista,children:s.detalles.map((e,o)=>t.jsxs("div",{className:a.productoDetalle,children:[t.jsx("span",{className:a.nombreProducto,children:e.Nombre_Producto}),t.jsxs("span",{children:["Cantidad: ",e.Cantidad]}),t.jsxs("span",{children:["Precio: $",e.Precio_Unitario.toFixed(2)]}),t.jsxs("span",{children:["Subtotal: $",e.Subtotal.toFixed(2)]})]},o))})]}),t.jsx("div",{className:a.totalFactura,children:t.jsxs("strong",{children:["Total: $",s.total.toFixed(2)]})}),t.jsx("div",{className:a.accionesModal,children:s.cliente.NumCelular&&t.jsxs("button",{onClick:()=>L(s.factura),className:`${a.button} ${a.whatsappButton}`,disabled:j,children:[t.jsx(W,{size:16})," Enviar WhatsApp"]})})]})]})}):null,re=()=>g?t.jsx("div",{className:a.modalOverlay,children:t.jsxs("div",{className:a.modalWindow,children:[t.jsx("button",{className:a.modalClose,onClick:()=>C(null),children:t.jsx(U,{size:20})}),t.jsx("h3",{className:a.modalTitle,children:"Editar factura"}),t.jsxs("div",{className:a.modalForm,children:[["ID_Pedido","ID_Cliente","Fecha","Monto_Total"].map(e=>t.jsx("input",{className:a.input,type:e==="Fecha"?"date":e==="Monto_Total"?"number":"text",step:e==="Monto_Total"?"0.01":void 0,name:e,value:g.formData[e],onChange:Q,placeholder:e.replace("_"," ")},e)),t.jsxs("div",{className:a.botones,children:[t.jsx("button",{onClick:Z,className:a.button,disabled:j,children:"Guardar"}),t.jsx("button",{onClick:()=>C(null),className:a.button,children:"Cancelar"})]})]})]})}):null;return t.jsxs("div",{className:a.container,children:[T.texto&&t.jsx("div",{className:`${a.mensaje} ${a[T.tipo]}`,children:T.texto}),(j||N)&&t.jsxs("div",{className:a.loadingOverlay,children:[t.jsx("div",{className:a.spinner}),t.jsx("p",{children:"Procesando..."})]}),m&&i&&t.jsx("div",{className:a.clienteInfo,children:t.jsxs("p",{children:["Cliente actual: ",t.jsxs("strong",{children:[i.Nombre," ",i.Apellido]})]})}),t.jsxs("div",{className:a.formContainer,children:[t.jsx("h1",{className:a.formTitle,children:"Agregar facturas"}),t.jsxs("form",{onSubmit:Y,className:a.form,children:[Object.keys(q).map(e=>t.jsx("input",{className:a.input,type:e==="Fecha"?"date":e==="Monto_Total"?"number":"text",step:e==="Monto_Total"?"0.01":void 0,placeholder:e==="ID_Cliente"&&m?"ID Cliente (autocompletado)":e.replace("_"," del "),required:e!=="ID_Cliente"||!m,name:e,value:c[e],onChange:X,disabled:e==="ID_Cliente"&&m},e)),t.jsx("button",{type:"submit",className:a.button,disabled:j||N,children:"Guardar Datos"})]})]}),t.jsxs("div",{className:a.listContainer,children:[t.jsx("h1",{className:a.listTitle,children:"Lista de facturas"}),b?t.jsx("div",{children:(F==null?void 0:F.length)>0?F.map(e=>t.jsx(ne,{factura:e},e.ID_Factura)):t.jsx("p",{children:"No se encontraron facturas"})}):t.jsx("div",{className:a.loadingMessage,children:t.jsx("p",{children:"Cargando datos..."})})]}),t.jsx(se,{}),t.jsx(re,{})]})};export{Ge as default};
